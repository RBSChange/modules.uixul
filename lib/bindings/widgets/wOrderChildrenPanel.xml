<?xml version="1.0" encoding="UTF-8"?>
<bindings
	xmlns="http://www.mozilla.org/xbl"
	xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">


<!--
wRenameBox
	@author INTbonjF
	@date   2006-04-18
-->
	<binding
		id="wOrderChildrenPanel" extends="widgets.wPanel#wPanel">


		<implementation>

			<field name="_defaultAttachmentAttribute">'selectedcomponents'</field>
			<field name="_parentId">null</field>
			<field name="relationName">null</field>
			<field name="relationType">null</field>
			<field name="componentTypes">null</field>
			<field name="icons">null</field>


			<property name="crop">
				<getter><![CDATA[
					if (this.hasAttribute('crop'))
					{
						return this.getAttribute('crop');
					}
					return 'end';
				]]></getter>
			</property>


			<constructor><![CDATA[
				var _this = this;
				this.getElementById('btnSubmit').addEventListener(
					'command',
					function() { _this.submit(); },
					true
					);
				this.setRelationName(null);
			]]></constructor>


			<method name="setRelationName">
				<parameter name="relationName" />
				<body><![CDATA[
					if (relationName == null)
					{
						this.relationName = null;
						this.relationType = 't';
					}
					else
					{
						this.relationName = relationName;
						this.relationType = 'c';
					}
				]]></body>
			</method>

			<method name="setComponentTypes">
				<parameter name="componentTypes" />
				<body><![CDATA[
					this.componentTypes = componentTypes;
				]]></body>
			</method>

			<method name="setIcons">
				<parameter name="icons" />
				<body><![CDATA[
					this.icons = icons;
				]]></body>
			</method>

			<method
				name="handleBroadcast"
				doc-access="private">
				<parameter name="observes" />
				<body><![CDATA[
					if ( ! this.hasAttribute('collapsed') )
					{
						var val = this.getAttribute('selectedids');
						if (val)
						{
							this._parentId = val;
							this.getController().execute("GetDocumentList", this, "uixul", "GetDocumentList",
								{
									{K::COMPONENT_ID_ACCESSOR}: this._parentId,
									includeFolder: 1,
									rt: this.relationType,
									rn: this.relationName,
									{K::COMPONENT_ACCESSOR}: this.componentTypes,
									icons: this.icons
								}
							);
							return;
						}						
						
						var val = this.getAttribute('selectedcomponents');
						if (val)
						{
							var e4x = new XML(val);
							this._parentId = e4x.document[0].component.(@name=="id").toString();
							this.getController().execute("GetDocumentList", this, "uixul", "GetDocumentList",
								{
									{K::COMPONENT_ID_ACCESSOR}: this._parentId,
									includeFolder: 1,
									rt: this.relationType,
									rn: this.relationName,
									{K::COMPONENT_ACCESSOR}: this.componentTypes,
									icons: this.icons
								}
							);
						}
					}
				]]></body>
			</method>


			<method name="onGetDocumentListSuccess">
				<parameter name="e4x" />
				<body><![CDATA[
				    var listbox = this.getElementById('listbox');
					listbox.empty();
					var count = e4x.document.length();
					if (count < 2)
					{
						this.getElementById("deck").selectedIndex = 1;
					}
					else
					{
						this.getElementById("deck").selectedIndex = 0;
						var rows  = Math.min(count, 10);
						listbox.setAttribute("rows", rows + 1);
						for (var i=0 ; i<count ; i++)
						{
							listbox.addItem(
								e4x.document[i].@id.toString(),
								e4x.document[i].toString(),
								e4x.document[i].@icon.toString()
								);
						}
					}
				]]></body>
			</method>


			<method name="submit">
				<body><![CDATA[
					var listbox = this.getElementById('listbox');
					var value = listbox.value;
					var result = [ ];
					for (var i=0 ; i<value.length ; i++)
					{
						result[' '+value[i]] = i;
					}
					this.getController().execute(
						"&modules.uixul.orderChildrenPanel.ordering-elements;",
						this,
						"{K::GENERIC_MODULE_NAME}",
						"Order",
						{
							{K::PARENT_ID_ACCESSOR}: this._parentId,
							{K::CHILDREN_ORDER_ACCESSOR}: result,
							rt: this.relationType,
							rn: this.relationName
						}
						);
				]]></body>
			</method>


			<method name="onOrderSuccess">
				<parameter name="e4x" />
				<body><![CDATA[
					try
					{
						this.getModule().refreshAll();
					} 
					catch (e)
					{
						wCore.error("wOrderChildrenPanel.onOrderSuccess", [e4x], e);
					}
					this.hide();
				]]></body>
			</method>


			<method name="moveSelectedItems">
				<parameter name="dir" />
				<parameter name="offset" />
				<body><![CDATA[
					if (!offset)
					{
						offset = 1;
					}
					for (var i=0; i<offset; i++)
					{
						this.getElementById('listbox').moveSelectedItems(dir);
					}
				]]></body>
			</method>


		</implementation>


		<xbl:content
			xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
			xmlns:xbl="http://www.mozilla.org/xbl">
			<vbox flex="1" class="panel">
				<wpanelheader icon="{IconsBase}/command/shadow/document_exchange.png" label="&amp;modules.uixul.bo.orderChildrenPanel.Order-children-panel-title;" helptext="&amp;modules.uixul.bo.orderChildrenPanel.Order-children-help-text;" />
				<deck anonid="deck" flex="1">
					<vbox flex="1">
						<toolbox class="change-toolbox">
							<toolbar class="change-toolbar">
								<toolbarbutton xbl:inherits="disabled" anonid="btnMoveUp" tooltiptext="&amp;modules.uixul.bo.orderChildrenPanel.Move-up;" image="{IconsBase}/small/shadow/arrow_up_blue.png" oncommand="moveSelectedItems('up', 1)" type="menu-button">
									<observes element="wcontroller" attribute="disabled" />
									<menupopup>
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-up-by-5;" oncommand="moveSelectedItems('up', 4)" />
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-up-by-10;" oncommand="moveSelectedItems('up', 9)" />
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-up-by-100;" oncommand="moveSelectedItems('up', 99)" />
									</menupopup>
								</toolbarbutton>
								<toolbarbutton xbl:inherits="disabled" anonid="btnMoveDown" tooltiptext="&amp;modules.uixul.bo.orderChildrenPanel.Move-down;" image="{IconsBase}/small/shadow/arrow_down_blue.png" oncommand="moveSelectedItems('down')" type="menu-button">
									<observes element="wcontroller" attribute="disabled" />
									<menupopup>
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-down-by-5;" oncommand="moveSelectedItems('down', 4)" />
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-down-by-10;" oncommand="moveSelectedItems('down', 9)" />
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-down-by-100;" oncommand="moveSelectedItems('down', 99)" />
									</menupopup>
								</toolbarbutton>
								<toolbarbutton xbl:inherits="disabled" anonid="btnSubmit" tooltiptext="&amp;modules.uixul.bo.orderChildrenPanel.Apply-changes;" image="{IconsBase}/small/shadow/check.png">
									<observes element="wcontroller" attribute="disabled" />
								</toolbarbutton>
								<spacer flex="1" />
							</toolbar>
						</toolbox>
						<wform flex="1" style="overflow:hidden">
							<wlistbox orderable="true" anonid="listbox" field-name="listbox" flex="1" hideheader="true" hidebuttons="true" />
						</wform>
					</vbox>
					<vbox flex="1">
						<description>&amp;modules.uixul.bo.orderChildrenPanel.cannot-order-children;</description>
					</vbox>
				</deck>
			</vbox>
		</xbl:content>


    </binding>


</bindings>
