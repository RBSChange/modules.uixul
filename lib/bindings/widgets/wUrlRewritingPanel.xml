<?xml version="1.0"?>
<bindings
	xmlns="http://www.mozilla.org/xbl"
	xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">

	<binding id="wUrlRewritingPanel" extends="widgets.wPanel#wPanel">
		<implementation>

			<field name="_defaultAttachmentAttribute">'selectedcomponents'</field>
			<field name="_componentId">null</field>
			<field name="_componentLang">null</field>
			<field name="pageId">null</field>
			<field name="pageLang">null</field>

			<constructor><![CDATA[
				var _this = this;
				this.getElementById('btnSubmit').addEventListener('command', function() { _this.submit(); }, true);
				this.getElementById('btnRemove').addEventListener('command', function() { _this.removeRedirection(); }, true);
			]]></constructor>

			<method name="handleBroadcast" >
				<parameter name="observes" />
				<body><![CDATA[
					if ( ! this.hasAttribute('collapsed') )
					{
						var val = this.getAttribute('selectedids');
						if (val)
						{
							this.clear();
							this._componentId = val;
							this._componentLang = this.getModule().getContextLang();
							this.getController().execute("GetUrlRewritingInfo", this, "website",
								"GetUrlRewritingInfo", {cmpref: this._componentId, lang: this._componentLang});
							return;
						}	
					
						var val = this.getAttribute('selectedcomponents');
						if (val)
						{
							this.clear();
							var e4x = new XML(val);
							this._componentId   = e4x.document[0].component.(@name=="id").toString();
							this._componentLang = e4x.document[0].component.(@name=="lang").toString();
							this.getController().execute("GetUrlRewritingInfo", this, "website",
								"GetUrlRewritingInfo", {cmpref: this._componentId, lang: this._componentLang});
						}
					}
				]]></body>
			</method>


			<method name="onGetUrlRewritingInfoSuccess">
				<parameter name="e4x" />
				<body><![CDATA[
					var form = this.getElementById('form');
					this.pageId = e4x.page.@id.toString();
					this.pageLang = e4x.page.@lang.toString();
					form.getFieldByName('page_url').value = e4x.page.@url.toString();
					var movedPermanently = e4x.page.@movedPermanently.toString() == 'true' ? true : false;
					form.getFieldByName('page_moved').checked = movedPermanently;
					this.permanentRedirection = e4x.page.@movedTo.toString();
					form.getFieldByName('page_moved').setAttribute(
						'label',
						"&modules.uixul.bo.urlRewritingPanel.Redirects-tolabel; "+this.permanentRedirection
						);
				]]></body>
			</method>


			<method name="submit">
				<body><![CDATA[
					var values = [ ];
					var form = this.getElementById('form');
					var url = form.getFieldValue("page_url");
					if (!/^[a-zA-Z0-9\-\_\.\/,]*$/.test(url))
					{
						alert("&amp;modules.uixul.bo.urlRewritingPanel.Url-error;");
						return;
					}
					else if (url == '')
					{
						this.removeRedirection();
						return;
					}
					
					var parameters = {
						{K::COMPONENT_ID_ACCESSOR} : this.pageId,
						{K::LANG_ACCESSOR} : this.pageLang,
						url : url,
						moved : form.getFieldValue("page_moved")
					};
					this.getController().execute(
						"&amp;modules.urlrewriting.backoffice.Saving-information;",
						this,
						"website",
						"SaveUrlRewritingInfo",
						parameters
						);
				]]></body>
			</method>


			<method name="removeRedirection">
				<body><![CDATA[
					var values = [ ];
					var form = this.getElementById('form');
					var parameters = {
						{K::COMPONENT_ID_ACCESSOR} : this.pageId,
						{K::LANG_ACCESSOR} : this.pageLang
					};
					this.getController().execute(
						"&amp;modules.website.bo.general.Saving-information;",
						this,
						"website",
						"RemoveUrlRewritingInfo",
						parameters
						);
				]]></body>
			</method>


			<method name="onRemoveUrlRewritingInfoSuccess">
				<body><![CDATA[
					this.hide();
				]]></body>
			</method>


			<method name="onSaveUrlRewritingInfoSuccess">
				<parameter name="response" />
				<body><![CDATA[
					this.hide();
				]]></body>
			</method>

			<method name="clear">
				<body><![CDATA[
					this.pageId = null;
					this.pageLang = null;
					var form = this.getElementById('form');
					form.getFieldByName('page_url').value = '';
					form.getFieldByName('page_moved').checked = false;
					form.getFieldByName('page_moved').setAttribute(
						'label',
						"&modules.uixul.bo.urlRewritingPanel.Redirects-tolabel;"
						);
				]]></body>
			</method>

		</implementation>


		<xbl:content
			xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
			xmlns:xbl="http://www.mozilla.org/xbl">
			<vbox flex="1" class="panel">
				<wpanelheader icon="{IconsBase}/small/urlrewriting.png" label="&amp;modules.uixul.bo.urlRewritingPanel.Panel-title;" />
				<toolbox class="change-toolbox">
					<toolbar class="change-toolbar">
						<toolbarbutton xbl:inherits="disabled" anonid="btnSubmit" tooltiptext="&amp;modules.website.bo.general.Apply-changes;" image="{IconsBase}/small/shadow/check.png">
							<observes element="wcontroller" attribute="disabled" />
						</toolbarbutton>
						<toolbarbutton xbl:inherits="disabled" anonid="btnRemove" tooltiptext="&amp;modules.website.bo.general.Remove-redirection;" image="{IconsBase}/small/shadow/delete2.png">
							<observes element="wcontroller" attribute="disabled" />
						</toolbarbutton>
						<spacer flex="1" />
					</toolbar>
				</toolbox>
				<wform anonid="form" orient="vertical" flex="1" standalone="true">
					<label value="&amp;modules.uixul.bo.urlRewritingPanel.Url-info;" />
					<wtextbox name="page_url" flex="1" size="65" maxlength="255">
						<constraint name="matches">^[a-zA-Z0-9\-\_\./,]+$</constraint>
					</wtextbox>
					<wcheckbox show-indicator="false" label="Permanent redirection" name="page_moved" value="true" />
				</wform>
			</vbox>
		</xbl:content>


    </binding>

</bindings>
