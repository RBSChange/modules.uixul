<?xml version="1.0" encoding="utf-8"?>
<bindings xmlns="http://www.mozilla.org/xbl" 
	xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul" 
	xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" 
	xmlns:xbl="http://www.mozilla.org/xbl">
	
	<binding id="cOrderChildrenDialog" extends="core.wDialog#wDialog">
		<implementation>
			<field name="_parentId">null</field>
			<field name="relationName">null</field>
			<field name="relationType">null</field>
			<field name="componentTypes">null</field>
			<field name="icons">null</field>

			<constructor>
			<![CDATA[
				wCore.debug("cOrderChildrenDialog.constructor");
			]]></constructor>
			
			<method name="onInitialize">
				<body><![CDATA[
					this.resizeTo(400, 400);
					var param = this.parameters;
					this._parentId = param.id;
					this.setRelationName(param.relationName);
					this.setComponentTypes(param.componentTypes);
					this.setIcons(param.icons);
					
					this.controller.execute("GetDocumentList", this, "uixul", "GetDocumentList",
						{
							{K::COMPONENT_ID_ACCESSOR}: this._parentId,
							includeFolder: 1,
							rt: this.relationType,
							rn: this.relationName,
							{K::COMPONENT_ACCESSOR}: this.componentTypes,
							icons: this.icons,
							lang: Context.W_LANG
						}
					);
							
				]]></body>
			</method>
					
			
			<method name="setRelationName">
				<parameter name="relationName" />
				<body><![CDATA[
					if (relationName == null)
					{
						this.relationName = null;
						this.relationType = 't';
					}
					else
					{
						this.relationName = relationName;
						this.relationType = 'c';
					}
				]]></body>
			</method>

			<method name="setComponentTypes">
				<parameter name="componentTypes" />
				<body><![CDATA[
					this.componentTypes = componentTypes;
				]]></body>
			</method>

			<method name="setIcons">
				<parameter name="icons" />
				<body><![CDATA[
					this.icons = icons;
				]]></body>
			</method>

			<method name="onGetDocumentListSuccess">
				<parameter name="e4x" />
				<body><![CDATA[
				    var listbox = this.getElementById('listbox');
					listbox.empty();
					var count = e4x.document.length();
					if (count < 2)
					{
						this.getElementById("deck").selectedIndex = 1;
					}
					else
					{
						this.getElementById("deck").selectedIndex = 0;
						var rows  = Math.min(count, 10);
						listbox.setAttribute("rows", rows + 1);
						for (var i=0 ; i<count ; i++)
						{
							listbox.addItem(
								e4x.document[i].@id.toString(),
								e4x.document[i].toString(),
								e4x.document[i].@icon.toString()
								);
						}
					}
				]]></body>
			</method>

			<method name="moveSelectedItems">
				<parameter name="dir" />
				<parameter name="offset" />
				<body><![CDATA[
					if (!offset)
					{
						offset = 1;
					}
					for (var i=0; i<offset; i++)
					{
						this.getElementById('listbox').moveSelectedItems(dir);
					}
				]]></body>
			</method>

			<method name="onOk">
				<body><![CDATA[
					var listbox = this.getElementById('listbox');
					var value = listbox.value;
					var result = [ ];
					for (var i=0 ; i<value.length ; i++)
					{
						result[' '+value[i]] = i;
					}
					this.controller.execute("Order", this, "generic", "Order",
						{
							{K::PARENT_ID_ACCESSOR}: this._parentId,
							{K::CHILDREN_ORDER_ACCESSOR}: result,
							rt: this.relationType,
							rn: this.relationName
						}
					);
				]]></body>
			</method>
			
			<method name="onOrderSuccess">
				<parameter name="e4x" />
				<body><![CDATA[
					this.sender.refresh();
					this.controller.closeModalDialog(true);
				]]></body>
			</method>		
		</implementation>

		<xbl:content
			xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
			xmlns:xbl="http://www.mozilla.org/xbl">
			<vbox flex="1">
				<hbox class="dialog-header">
					<label anonid="title" value="&amp;modules.uixul.bo.orderChildrenPanel.Order-children-panel-title;" class="dialog-title" />
					<spacer flex="1" />
					<vbox pack="center">
						<toolbarbutton height="16" width="16" change:icon="delete/small" oncommand="onCancel();" tooltiptexts="&amp;modules.uixul.bo.dialog.Cancel;" />
					</vbox>
				</hbox>
				<deck anonid="deck" flex="1">
					<vbox flex="1">
						<toolbox class="change-toolbox">
							<toolbar class="change-toolbar">
								<toolbarbutton xbl:inherits="disabled" anonid="btnMoveUp" tooltiptext="&amp;modules.uixul.bo.orderChildrenPanel.Move-up;" image="{HttpHost}/icons/small/arrow-up-blue.png" oncommand="moveSelectedItems('up', 1)" type="menu-button">
									<observes element="wcontroller" attribute="disabled" />
									<menupopup>
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-up-by-5;" oncommand="moveSelectedItems('up', 4)" />
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-up-by-10;" oncommand="moveSelectedItems('up', 9)" />
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-up-by-100;" oncommand="moveSelectedItems('up', 99)" />
									</menupopup>
								</toolbarbutton>
								<toolbarbutton xbl:inherits="disabled" anonid="btnMoveDown" tooltiptext="&amp;modules.uixul.bo.orderChildrenPanel.Move-down;" image="{HttpHost}/icons/small/arrow-down-blue.png" oncommand="moveSelectedItems('down')" type="menu-button">
									<observes element="wcontroller" attribute="disabled" />
									<menupopup>
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-down-by-5;" oncommand="moveSelectedItems('down', 4)" />
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-down-by-10;" oncommand="moveSelectedItems('down', 9)" />
										<menuitem label="&amp;modules.uixul.bo.orderChildrenPanel.Move-down-by-100;" oncommand="moveSelectedItems('down', 99)" />
									</menupopup>
								</toolbarbutton>
								<spacer flex="1" />
							</toolbar>
						</toolbox>
						<wform flex="1" style="overflow:hidden">
							<wlistbox orderable="true" anonid="listbox" field-name="listbox" flex="1" hideheader="true" hidebuttons="true" />
						</wform>
					</vbox>
					<vbox flex="1">
						<description>&amp;modules.uixul.bo.orderChildrenPanel.cannot-order-children;</description>
					</vbox>
				</deck>
				<hbox>
					<button width="100px" change:icon="check/small" oncommand="onOk();" label="&amp;modules.uixul.bo.dialog.Apply;" />
					<spacer flex="1" />
					<button width="100px" change:icon="delete/small" oncommand="onCancel();" label="&amp;modules.uixul.bo.dialog.Cancel;" />
				</hbox>					
			</vbox>
		</xbl:content>
    </binding>
</bindings>
